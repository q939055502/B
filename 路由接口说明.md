# 路由接口说明

本文档详细列出了系统中所有API路由接口的信息，包括请求方法、参数格式、功能描述、权限要求等，为前端开发提供接口参考。

## 一、用户相关路由 (user_bp)

### 1. 用户登录
- **路径**: `/user/login`
- **请求方法**: `POST`
- **参数格式**:
  ```json
  {
    "email": "用户邮箱",
    "password": "用户密码"
  }
  ```
- **功能描述**: 用户登录认证，验证邮箱和密码，成功后返回JWT令牌
- **权限要求**: 无
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，401表示认证失败
    "message": "提示信息",
    "data": {
      "access_token": "访问令牌",
      "refresh_token": "刷新令牌",
      "token_type": "Bearer",
      "expires_in": 3600
    }
  }
  ```

### 2. 用户注册
- **路径**: `/user/register`
- **请求方法**: `POST`
- **参数格式**:
  ```json
  {
    "email": "用户邮箱",
    "password": "用户密码",
    "confirm_password": "确认密码",
    "username": "用户名",
    "verification_code": "验证码"
  }
  ```
- **功能描述**: 用户注册，验证邮箱、密码格式和验证码，创建新用户
- **权限要求**: 无
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，400表示参数错误
    "message": "提示信息",
    "data": {}
  }
  ```

### 3. 发送邮箱验证码
- **路径**: `/user/send-email-verification`
- **请求方法**: `POST`
- **参数格式**:
  ```json
  {
    "email": "用户邮箱",
    "verification_type": "验证类型(register/forgot_password)"
  }
  ```
- **功能描述**: 向指定邮箱发送验证码
- **权限要求**: 无
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，400表示参数错误
    "message": "提示信息",
    "data": {}
  }
  ```

### 4. 忘记密码
- **路径**: `/user/forgot-password`
- **请求方法**: `POST`
- **参数格式**:
  ```json
  {
    "email": "用户邮箱"
  }
  ```
- **功能描述**: 验证邮箱是否存在，生成密码重置令牌并发送重置邮件
- **权限要求**: 无
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，404表示邮箱不存在
    "message": "提示信息",
    "data": {}
  }
  ```

### 5. 重置密码
- **路径**: `/user/reset-password`
- **请求方法**: `POST`
- **参数格式**:
  ```json
  {
    "token": "密码重置令牌",
    "new_password": "新密码",
    "confirm_password": "确认新密码"
  }
  ```
- **功能描述**: 验证重置令牌有效性，检查新密码格式，更新用户密码
- **权限要求**: 无
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，400表示参数错误或令牌无效
    "message": "提示信息",
    "data": {}
  }
  ```

## 二、认证相关路由 (auth_bp)

### 1. 用户登出
- **路径**: `/auth/logout`
- **请求方法**: `POST`
- **参数格式**: 无
- **功能描述**: 用户登出，使当前令牌失效
- **权限要求**: 需要JWT认证
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，401表示未认证
    "message": "提示信息",
    "data": {}
  }
  ```

### 2. 刷新令牌
- **路径**: `/auth/refresh`
- **请求方法**: `POST`
- **参数格式**: 无（需要在请求头中提供刷新令牌）
- **功能描述**: 使用刷新令牌获取新的访问令牌
- **权限要求**: 需要JWT认证
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，401表示令牌无效
    "message": "提示信息",
    "data": {
      "access_token": "新的访问令牌",
      "token_type": "Bearer",
      "expires_in": 3600
    }
  }
  ```

### 3. 验证登录状态
- **路径**: `/auth/verify`
- **请求方法**: `GET`
- **参数格式**: 无
- **功能描述**: 验证当前令牌是否有效
- **权限要求**: 需要JWT认证
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示令牌有效，401表示令牌无效
    "message": "提示信息",
    "data": {}
  }
  ```

### 4. 获取用户信息
- **路径**: `/auth/get-user-info`
- **请求方法**: `GET`
- **参数格式**: 无
- **功能描述**: 获取当前登录用户的基本信息
- **权限要求**: 需要JWT认证
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，401表示未认证
    "message": "提示信息",
    "data": {
      "id": "用户ID",
      "username": "用户名",
      "email": "用户邮箱",
      "role": "用户角色",
      "created_at": "创建时间"
    }
  }
  ```

## 三、报告相关路由 (report_bp)

### 1. 获取所有报告
- **路径**: `/report/get-all-reports`
- **请求方法**: `GET`
- **参数格式**: 无
- **功能描述**: 获取系统中所有报告
- **权限要求**: 需要JWT认证，且具有'inspection_report.view.all'权限
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，403表示权限不足
    "message": "提示信息",
    "data": [{
      "report_code": "报告编号",
      "project_name": "项目名称",
      "client_unit": "委托单位",
      "inspection_object": "检测对象",
      "report_date": "报告日期",
      "report_status": "报告状态"
    }]
  }
  ```

### 2. 分页获取报告
- **路径**: `/report/get-reports`
- **请求方法**: `GET`
- **参数格式**: 查询参数
  - `page`: 当前页码（默认1）
  - `per_page`: 每页数量（默认10）
  - `search_keyword`: 搜索关键词
- **功能描述**: 分页获取报告列表，支持关键词搜索
- **权限要求**: 需要JWT认证
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，401表示未认证
    "message": "提示信息",
    "data": {
      "items": [{"report_code": "报告编号","project_name": "项目名称","client_unit": "委托单位","inspection_object": "检测对象","report_date": "报告日期","report_status": "报告状态"}],
      "total": "总记录数",
      "page": "当前页码",
      "pages": "总页数"
    }
  }
  ```

### 3. 根据报告编号获取报告
- **路径**: `/report/get-report-by-code`
- **请求方法**: `GET`
- **参数格式**: 查询参数
  - `report_code`: 报告编号
- **功能描述**: 根据报告编号获取报告详情
- **权限要求**: 无
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，404表示报告不存在
    "message": "提示信息",
    "data": {
      "report_code": "报告编号",
      "project_name": "项目名称",
      "client_unit": "委托单位",
      "inspection_object": "检测对象",
      "inspection_type": "检测类型",
      "inspection_conclusion": "检测结论",
      "report_date": "报告日期",
      "created_at": "创建时间",
      "updated_at": "更新时间"
    }
  }
  ```

### 4. 获取有效报告总数
- **路径**: `/report/get-total-active-reports`
- **请求方法**: `GET`
- **参数格式**: 无
- **功能描述**: 获取系统中有效报告的总数
- **权限要求**: 无
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功
    "message": "提示信息",
    "data": {
      "total_count": "有效报告总数"
    }
  }
  ```

### 5. 搜索报告
- **路径**: `/report/search`
- **请求方法**: `GET`
- **参数格式**: 查询参数
  - `search_keyword`: 搜索关键词
- **功能描述**: 根据关键词搜索报告
- **权限要求**: 需要JWT认证
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，401表示未认证
    "message": "提示信息",
    "data": [{"report_code": "报告编号","project_name": "项目名称","client_unit": "委托单位","inspection_object": "检测对象","report_date": "报告日期"}]
  }
  ```

### 6. 删除报告
- **路径**: `/report/delete-report/<report_code>`
- **请求方法**: `DELETE`
- **参数格式**: 路径参数
  - `report_code`: 报告编号
- **功能描述**: 软删除指定报告
- **权限要求**: 需要JWT认证，且具有'inspection_report.delete.own'权限
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，403表示权限不足
    "message": "提示信息",
    "data": {}
  }
  ```

### 7. 添加报告
- **路径**: `/report/add-report`
- **请求方法**: `POST`
- **参数格式**:
  ```json
  {
    "project_name": "项目名称",
    "client_unit": "委托单位",
    "inspection_object": "检测对象",
    "inspection_type": "检测类型",
    "inspection_conclusion": "检测结论",
    "inspection_unit": "检测单位",
    "registrant": "登记人",
    "report_date": "报告日期",
    "[其他报告相关字段]": "字段值"
  }
  ```
- **功能描述**: 创建新的检测报告
- **权限要求**: 需要JWT认证，且具有'inspection_report.create.all'权限
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，400表示参数错误
    "message": "提示信息",
    "data": {
      "report": {"report_code": "报告编号","project_name": "项目名称","client_unit": "委托单位","inspection_object": "检测对象","created_at": "创建时间"},
      "report_status": "报告状态"
    }
  }
  ```

### 8. 更新报告
- **路径**: `/report/update-report/<report_code>`
- **请求方法**: `PUT`
- **参数格式**: 路径参数 + 请求体
  - 路径参数: `report_code` (报告编号)
  - 请求体:
    ```json
    {
      "project_name": "项目名称",
      "client_unit": "委托单位",
      "inspection_object": "检测对象",
      "inspection_type": "检测类型",
      "inspection_conclusion": "检测结论",
      "inspection_unit": "检测单位",
      "registrant": "登记人",
      "[其他需要更新的字段]": "新的字段值"
    }
    ```
- **功能描述**: 更新指定报告的信息
- **权限要求**: 需要JWT认证，且具有'inspection_report.edit.own'权限
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，404表示报告不存在
    "message": "提示信息",
    "data": {
      "report": {"report_code": "报告编号","project_name": "更新后的项目名称","updated_at": "更新时间"}
    }
  }
  ```

### 9. 批量删除报告
- **路径**: `/report/batch-delete-reports`
- **请求方法**: `POST`
- **参数格式**:
  ```json
  {
    "report_codes": ["报告编号1", "报告编号2", ...]
  }
  ```
- **功能描述**: 批量软删除多个报告
- **权限要求**: 需要JWT认证，且具有'inspection_report.delete.own'权限
- **响应格式**:
  ```json
  {
    "success": true/false,
    "code": 200,  // 示例：200表示操作成功，400表示参数错误
    "message": "提示信息",
    "data": {
      "total_count": "总删除数量",
      "success_count": "成功删除数量",
      "failed_count": "删除失败数量",
      "failed_reports": ["删除失败的报告编号"]
    }
  }
  ```

## 四、遗留路由 (main_bp)

### 1. 首页路由
- **路径**: `/`
- **请求方法**: `GET`
- **参数格式**: 查询参数
  - `page`: 当前页码（默认1）
- **功能描述**: 展示检测报告列表（已迁移至/api/reports，仅保留兼容）
- **权限要求**: 需要登录认证
- **响应格式**: HTML页面

## 五、通用响应格式说明

所有API接口遵循统一的响应格式：
```json
{
  "success": true/false,  // 操作是否成功
  "code": 200,         // HTTP状态码，示例：200表示操作成功
  "message": "提示信息",  // 操作结果描述
  "data": { ... }         // 具体返回数据
}
```

常见HTTP状态码说明：
- 200: 操作成功
- 400: 请求参数错误
- 401: 未认证或认证失败
- 403: 权限不足
- 404: 资源不存在
- 500: 服务器内部错误

## 六、权限说明

API接口权限控制使用JWT认证和基于角色的权限管理(RBAC)：
1. 部分接口无需认证即可访问（如登录、注册）
2. 大部分接口需要JWT认证
3. 部分敏感操作需要特定权限（如添加、删除报告）

权限格式：`resource.action.scope`
- resource: 资源类型（如'inspection_report'）
- action: 操作类型（如'view', 'create', 'edit', 'delete'）
- scope: 作用范围（如'all', 'own'）

例如：'inspection_report.view.all' 表示可以查看所有检测报告。